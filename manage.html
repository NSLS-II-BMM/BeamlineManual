

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>13. Managing the beamline &#8212; BMM Beamline Manual 0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'manage';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="14. Common chores" href="commonchores.html" />
    <link rel="prev" title="12. Experimental Log" href="log.html" />

    <link rel="stylesheet" type="text/css" href="_static/demeter.css" />
    <link rel="stylesheet" type="text/css" href="_static/keys.css" />
    <link rel="stylesheet" type="text/css" href="_static/program.css" />
    <link rel="stylesheet" type="text/css" href="_static/color.css" />

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/floor_mat.png" class="logo__image only-light" alt="BMM Beamline Manual 0.1 documentation - Home"/>
    <script>document.write(`<img src="_static/floor_mat.png" class="logo__image only-dark" alt="BMM Beamline Manual 0.1 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">User documentation</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction to BMM</a></li>
<li class="toctree-l1"><a class="reference internal" href="proposal.html">2. Proposal Writing for BMM</a></li>
<li class="toctree-l1"><a class="reference internal" href="before.html">3. Before your Beamtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">4. Data access</a></li>
<li class="toctree-l1"><a class="reference internal" href="instruments.html">5. Beamline instrumentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="motors.html">6. Moving and querying motors</a></li>
<li class="toctree-l1"><a class="reference internal" href="pds.html">7. Photon Delivery System</a></li>
<li class="toctree-l1"><a class="reference internal" href="linescans.html">8. Sample position scans</a></li>
<li class="toctree-l1"><a class="reference internal" href="xafs.html">9. XAFS scans</a></li>
<li class="toctree-l1"><a class="reference internal" href="other.html">10. Other measurement needs</a></li>
<li class="toctree-l1"><a class="reference internal" href="automation.html">11. Beamline automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="log.html">12. Experimental Log</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">13. Managing the beamline</a></li>
<li class="toctree-l1"><a class="reference internal" href="commonchores.html">14. Common chores</a></li>
<li class="toctree-l1"><a class="reference internal" href="cheatsheet.html">15. Command cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="trouble.html">16. Troubleshooting</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Staff documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="desktop.html">A. BMM’s Desktop</a></li>
<li class="toctree-l1"><a class="reference internal" href="profile.html">B. An overview of BMM’s profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="kafka.html">C. Kafka workers at BMM</a></li>
<li class="toctree-l1"><a class="reference internal" href="ionchambers.html">D. Ion chamber signal chains</a></li>
<li class="toctree-l1"><a class="reference internal" href="details.html">E. Instrumentation Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="restore.html">F. Power outage recovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="photos.html">G. Photo Galleries</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">H. To Do List</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/NSLS2/bmm-beamline-manual" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/NSLS2/bmm-beamline-manual/issues/new?title=Issue%20on%20page%20%2Fmanage.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/manage.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Managing the beamline</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-and-ending-an-experiment">13.1. Starting and ending an experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#change-energy">13.2. Change energy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#change-crystals">13.3. Change crystals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#change-xas-larr-xrd">13.4. Change XAS → XRD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#xafs-with-si-333">13.5. XAFS with Si(333)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motor-controller-kill-switches">13.6. Motor controller kill switches</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#old-kill-switch-system">13.6.1. Old kill switch system</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mcs8-connector">13.6.2. MCS8 Connector</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#windows-vm-and-biologic">13.7. Windows VM and BioLogic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-the-virtual-machine">13.7.1. Starting the virtual machine</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-electrochemistry-or-mass-spectrometry-data">13.7.2. Storing electrochemistry or mass spectrometry data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-the-mono">13.8. Calibrate the mono</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#provision-a-new-beamline-computer">13.9. Provision a new beamline computer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-additional-packages">13.9.1. install additional packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#desktop-wallpaper">13.9.2. Desktop wallpaper</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#things-to-install-from-git">13.9.3. Things to install from git</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#workspace-folders">13.9.4. Workspace folders</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#manage-silicon-drift-detectors">13.10. Manage Silicon Drift Detectors</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="managing-the-beamline">
<span id="manage"></span><h1><span class="section-number">13. </span>Managing the beamline<a class="headerlink" href="#managing-the-beamline" title="Permalink to this heading">#</a></h1>
<p>In this section, some recipes are provided for managing the beamline
and meeting the needs and expectations of different experiments.</p>
<section id="starting-and-ending-an-experiment">
<span id="start-end"></span><h2><span class="section-number">13.1. </span>Starting and ending an experiment<a class="headerlink" href="#starting-and-ending-an-experiment" title="Permalink to this heading">#</a></h2>
<p>When a new experiment begins, run the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BMMuser</span><span class="o">.</span><span class="n">begin_experiment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Betty Cooper&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;2019-02-29&#39;</span><span class="p">,</span> <span class="n">gup</span><span class="o">=</span><span class="mi">123456</span><span class="p">,</span> <span class="n">saf</span><span class="o">=</span><span class="mi">654321</span><span class="p">)</span>
</pre></div>
</div>
<p>This will create that data folder and populate it with an
<a class="reference internal" href="log.html#log"><span class="std std-numref">experimental log (Section 12)</span></a>, write a template for a
<a class="reference internal" href="xafs.html#macro"><span class="std std-numref">macro file (Section 9.6)</span></a>, configure the logger to
write a <a class="reference internal" href="log.html#logfile"><span class="std std-numref">user log file (Section 12.1)</span></a> for this
experiment, set the GUP and SAF numbers as metadata for output files,
set up <a class="reference internal" href="log.html#snap"><span class="std std-numref">snapshot (Section 12.2)</span></a> and <a class="reference internal" href="log.html#dossier"><span class="std std-numref">dossier
(Section 12.4)</span></a> folders, and perform other experiment start-up
chores.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">name</span></code> should be the PI’s full name, preferably transliterated
into normal ASCII.  The <code class="docutils literal notranslate"><span class="pre">date</span></code> should be the starting day of the
experiment in the <code class="docutils literal notranslate"><span class="pre">YYYY-MM-DD</span></code> format.  The <code class="docutils literal notranslate"><span class="pre">GUP</span></code> and <code class="docutils literal notranslate"><span class="pre">SAF</span></code>
numbers can be found on the posted safety approval form.</p>
<p>Once the experiment is finished, run this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BMMuser</span><span class="o">.</span><span class="n">end_experiment</span><span class="p">()</span>
</pre></div>
</div>
<p>This will reset the logger and the <code class="docutils literal notranslate"><span class="pre">BMMuser.folder</span></code> variable and
unset the GUP and SAF numbers.</p>
</section>
<section id="change-energy">
<h2><span class="section-number">13.2. </span>Change energy<a class="headerlink" href="#change-energy" title="Permalink to this heading">#</a></h2>
<p>Changing energy is simple.  Usually, it is as simple as doing</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">change_edge</span><span class="p">(</span><span class="s1">&#39;Fe&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>replacing the two-letter element symbol with the element you actually
want to measure. This command will move the monochromator, put the
photon delivery system in the correct mode, move the M2 bender to
approximately the correct setting, run a rocking curve scan,
optimize the slit height, move the reference foil holder to the
correct position (if configured), and select the correct ROI channel
(if configured).</p>
<p>If you want to reproduce this by hand, here is the command sequence:</p>
<ol class="arabic">
<li><p>First move the DCM to the new energy position.  It is usually a
good idea to move a bit above the target edge energy.  Here’s an
example for moving 50 eV above the iron K edge energy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">mv</span><span class="p">(</span><span class="n">dcm</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="mi">7112</span><span class="o">+</span><span class="mi">50</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>Put the beamline in the correct photon delivery system mode.  (See
the table just above.)  Continuing with the example of the iron K
edge, for unfocused beam:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">change_mode</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>If the new edge energy is in the same energy range according to the
table above, you can skip this step.  For example, Mn and Fe are
both in mode E (or mode C).  The <code class="docutils literal notranslate"><span class="pre">change_mode()</span></code> command does not
need to be run to move between those edges.</p>
</li>
<li><p>Measure a <a class="reference internal" href="linescans.html#special-linescans"><span class="std std-numref">rocking curve scan (Sec 8.2)</span></a>
to verify that the second crystal of the rocking curve is parallel
to the first crystal.  This is more important for large energy
changes.  You may find that you can skip this step if you are
changing between nearby edges.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">rocking_curve</span><span class="p">())</span>
</pre></div>
</div>
<p>At the end of the scan, the mono pitch will be moved to the top of
the rocking curve.</p>
</li>
<li><p>If using focused beam, make sure that the mirror bender is in the
correct position.  For focusing at the XAS table, <code class="docutils literal notranslate"><span class="pre">m2_bender</span></code>
should be at about 212000 counts.  For focusing at the position of
the goniometer, <code class="docutils literal notranslate"><span class="pre">m2_bender</span></code> should be about 112000 counts.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">mv</span><span class="p">(</span><span class="n">m2_bender</span><span class="p">,</span> <span class="mi">212000</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>Next, verify that the <a class="reference internal" href="linescans.html#special-linescans"><span class="std std-numref">height of the hutch slits (Sec 8.2)</span></a> is optimized for the beam height.  In
principle, this should be correct after changing photon delivery
system mode.  But it doesn’t hurt to verify.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">slit_height</span><span class="p">())</span>
</pre></div>
</div>
<p>At the end of the scan, you will need to pluck the correct position
from the plot.</p>
</li>
<li><p>Next, if you are using a reference foil, you should move the
reference foil holder to the slot containing the correct foil.  The
command is something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;Fe&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>choosing the correct element for your measurement.</p>
</li>
<li><p>Finally,  select the correct ROI channel:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">BMMuser</span><span class="o">.</span><span class="n">verify_roi</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<p>As a reminder, here is the table of operating modes.</p>
<div class="pst-scrollable-table-container"><span id="pds-modes"></span><table class="table table-left" id="pds-modes2">
<caption><span class="caption-number">Table 13.1 </span><span class="caption-text">Photon delivery modes</span><a class="headerlink" href="#pds-modes2" title="Permalink to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Mode</p></th>
<th class="head"><p>focused</p></th>
<th class="head"><p>energy range</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A</p></td>
<td><p>✓</p></td>
<td><p>above 8 keV</p></td>
</tr>
<tr class="row-odd"><td><p>B</p></td>
<td><p>✓</p></td>
<td><p>below 6 keV</p></td>
</tr>
<tr class="row-even"><td><p>C</p></td>
<td><p>✓</p></td>
<td><p>6 keV – 8 keV</p></td>
</tr>
<tr class="row-odd"><td><p>D</p></td>
<td><p>✗</p></td>
<td><p>above 8 keV</p></td>
</tr>
<tr class="row-even"><td><p>E</p></td>
<td><p>✗</p></td>
<td><p>6 keV – 8 keV</p></td>
</tr>
<tr class="row-odd"><td><p>F</p></td>
<td><p>✗</p></td>
<td><p>below 6 keV</p></td>
</tr>
<tr class="row-even"><td><p>XRD</p></td>
<td><p>✓</p></td>
<td><p>above 8 keV</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="change-crystals">
<h2><span class="section-number">13.3. </span>Change crystals<a class="headerlink" href="#change-crystals" title="Permalink to this heading">#</a></h2>
<p>Suppose you wanted to change from the Pt L3 edge (11564 eV) on the
Si(111) crystal to the same energy on the Si(311) crystal.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">change_xtal</span><span class="p">(</span><span class="s1">&#39;311&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This will move the lateral motor of the DCM and optimize the roll and
pitch of the second crystal.  It will then move the DCM to the energy
that you started at with the other crystal set and run a rocking curve
scan.</p>
<p>Note that some of these motions can be a bit surprising in the sense
that the monochromator will briefly report itself as being outside the
normal operating range of the beamline.  They will, however,
eventually return to sensible places.</p>
</section>
<section id="change-xas-larr-xrd">
<span id="xas-to-xrd"></span><h2><span class="section-number">13.4. </span>Change XAS → XRD<a class="headerlink" href="#change-xas-larr-xrd" title="Permalink to this heading">#</a></h2>
<p>To move the photon delivery system to delivery of focused beam to the
goniometer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">change_edge</span><span class="p">(</span><span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="n">xrd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="mi">8600</span><span class="p">))</span>
</pre></div>
</div>
<p>The element symbol in the first argument is not actually used in any
way when <code class="docutils literal notranslate"><span class="pre">xrd=True</span></code> is used, however the funtion requires
<span class="incremental">something</span> as its first argument.  Setting <code class="docutils literal notranslate"><span class="pre">xrd=True</span></code> forces the
<code class="docutils literal notranslate"><span class="pre">focus=True</span></code> and <code class="docutils literal notranslate"><span class="pre">target=0</span></code> arguments to the <code class="docutils literal notranslate"><span class="pre">change_edge()</span></code>
command to be set.  This will move to the specified energy, place the
photon delivery mode in <span class="incremental">XRD</span> mode, optimize the second
crystal and the slit height, and move to an approximately M2 bender
position.</p>
<p>To do all of that by hand, you would do the follow commands:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">change_mode</span><span class="p">(</span><span class="s1">&#39;XRD&#39;</span><span class="p">))</span>
<span class="n">RE</span><span class="p">(</span><span class="n">mv</span><span class="p">(</span><span class="n">dcm</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="mi">8600</span><span class="p">))</span>
<span class="n">RE</span><span class="p">(</span><span class="n">rocking_curve</span><span class="p">())</span>
<span class="n">RE</span><span class="p">(</span><span class="n">slit_height</span><span class="p">())</span>
</pre></div>
</div>
<p>This change of mode should have the beam in good focus at the position
of the goniometer.  8600 eV is the nominal operating energy for the
goniometer.  If a higher energy is required, substitute the correct
energy for <code class="docutils literal notranslate"><span class="pre">8600</span></code> in the second line.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The I<sub>0</sub> chamber should be left in place.  This will
facilitate changing energy while doing scattering
experiments. The flight path can be put in place at any time.</p>
</div>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Determine look-up table for lower energy operations using
both M2 and M3.  This will require a new XAFS table and
adjustments to the limit switches on <code class="docutils literal notranslate"><span class="pre">m3_ydo</span></code> and
<code class="docutils literal notranslate"><span class="pre">m3_ydi</span></code>.</p>
</div>
</section>
<section id="xafs-with-si-333">
<span id="use333"></span><h2><span class="section-number">13.5. </span>XAFS with Si(333)<a class="headerlink" href="#xafs-with-si-333" title="Permalink to this heading">#</a></h2>
<p>Using the Si(111) monochromator, it is possible to use the third
harmonic – the Si(333) reflection – to measure XAS with slightly
higher energy resolution.  In this section, we explain how to set up
the beamline to measure the Ge K edge at 11103 eV using the Si(333).</p>
<p>You cannot use the <code class="docutils literal notranslate"><span class="pre">change_edge()</span></code> command to do this.  Use of the
Si(111) (or Si(311)) is hard-wired into that plan.  You have to set up
the beamline by hand.</p>
<p>First, put the photon delivery system in mode D (or mode A if using
the focusing mirror):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">change_mode</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Next, move the monochromator to a few 10s of eV above the absorption
edge, as measured with the third harmonic.  The Ge K edge is at 11103
eV, so we need to move the monochromator to 11103/3 = 3701 eV.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">mv</span><span class="p">(</span><span class="n">dcm</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="p">(</span><span class="mi">11103</span><span class="o">+</span><span class="mi">27</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>or simply</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">mv</span><span class="p">(</span><span class="n">dcm</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="mi">3701</span><span class="o">+</span><span class="mi">9</span><span class="p">))</span>
</pre></div>
</div>
<p>This will put the third harmonic energy 27 eV above the Ge K edge.</p>
<p>Now, run a rocking curve scan:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">rocking_curve</span><span class="p">())</span>
</pre></div>
</div>
<p>This will produce a plot that looks something like this:</p>
<figure class="align-center" id="id3">
<span id="fig-rocking333"></span><a class="reference external image-reference" href="_images/rocking_curve_333_E=3716.png"><img alt="_images/rocking_curve_333_E%3D3716.png" src="_images/rocking_curve_333_E%3D3716.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.1 </span><span class="caption-text">A rocking curve scan with the photon delivery system in mode D and
the mono at 3716 eV.</span><a class="headerlink" href="#id3" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The broad base of this curve is the Si(111) rocking curve with photons
at 3710 eV. The sharp spike in the middle is the Si(333) rocking curve
with photons at 11130 eV.</p>
<p>Optimize the slit_height:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">slit_height</span><span class="p">())</span>
</pre></div>
</div>
<p>You are ready to measure XAS with the Si(333) reflection!</p>
<p>Here’s an example <code class="docutils literal notranslate"><span class="pre">scan.ini</span></code> file for XANES of elemental Ge:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[scan]</span>
<span class="na">experimenters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Bruce Ravel</span>

<span class="na">filename</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s">Ge</span>
<span class="na">sample</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s">elemental Ge, crystalline</span>
<span class="na">prep</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s">standard sample</span>
<span class="na">comment</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">measured with Si(333) reflection, 25um Al foil in beam path before I0</span>

<span class="na">ththth</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s">True</span>
<span class="na">e0</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s">11103</span>
<span class="na">element</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">Ge</span>
<span class="na">edge</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s">K</span>

<span class="na">nscans</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">start</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s">next</span>

<span class="c1">## mode is one of transmission, fluorescence, both, or reference</span>
<span class="na">mode</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">transmission</span>

<span class="c1">## Ge Si(333)</span>
<span class="na">bounds</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s">-45    -18     -9      36    150</span>
<span class="na">steps</span><span class="w">      </span><span class="o">=</span><span class="w">      </span><span class="s">9     0.9     0.3    0.9</span>
<span class="na">times</span><span class="w">      </span><span class="o">=</span><span class="w">      </span><span class="s">0.5    0.5    0.5    0.5</span>
</pre></div>
</div>
<p>Several things to note:</p>
<ol class="arabic simple">
<li><p>Note that the actual value for E0 is specified, not the divided-by-3 value.</p></li>
<li><p>Actual energy bounds and steps are specified, the xafs scan plan
will convert them to appropriately sized steps for the Si(111).</p></li>
<li><p>By setting the 333 flag to True, the correct thing will happen,
including writing the correct energy axis to the output data file.</p></li>
<li><p>The on-screen plot will show the fundamental – Si(111) – energy, however.</p></li>
<li><p>Also, you still need to set up the photon delivery system up by hand.</p></li>
</ol>
</section>
<section id="motor-controller-kill-switches">
<h2><span class="section-number">13.6. </span>Motor controller kill switches<a class="headerlink" href="#motor-controller-kill-switches" title="Permalink to this heading">#</a></h2>
<p>The MCS8 motor controllers supplied by FMBO have a kill switch for
power cycling the Phytron amplifier cards.  This is implemented by the
vendor as connector plugged into the back of the chassis which shorts
the two leads of the receptacle.  To kill the amplifiers, this plug is
removed and reinserted.</p>
<p>That’s fine, but the motor controllers are on top of the FOE – not
a convenient location.</p>
<p>The new kill switch system uses DIODE to close the kill switch
circuit. Two-conductor cable is run from each motor controller to a
remote DIODE box mounted on the inboard wall of the end station.</p>
<p>The Bluesky interface is defined <a class="reference external" href="https://github.com/NSLS2/bmm-profile-collection/blob/main/startup/BMM/killswitch.py">here</a></p>
<p>From the docstring of the class:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>A simple interface to the DIODE kill switches for the Phytron
amplifiers on the FMBO Delta Tau motor controllers.

In the BMM DIODE box, these are implemented on channels 0 to 4 of
slot 4.

attributes
----------
dcm
  kill switch for MC02, monochromator
slits2
  kill switch for MC03, DM2 slits
m2
  kill switch for MC04, focusing mirror
m3
  kill switch for MC05, harmonic rejection mirror
dm3
  kill switch for MC06, hutch slits and diagnostics

methods
-------
kill(mc)
  disable Phytron
enable(mc)
  activate Phytron
cycle(mc)
  disable, wait 5 seconds, reactivate, then re-enable all motors

Specify the motor controller as a string, i.e. &#39;dcm&#39;, &#39;slits2&#39;, &#39;m2&#39;, &#39;m3&#39;, &#39;dm3&#39;

Here is a common problem which is resolved using a kill switch.

   BMM E.111 [36] ▶ RE(mvr(m2.pitch, 0.05))
   INFO:BMM_logger:    Moving m2_pitch to 2.550

   Moving m2_pitch to 2.550
   ERROR:ophyd.objects:Motion failed: m2_yu is in an alarm state status=AlarmStatus.STATE severity=AlarmSeverity.MAJOR
   ERROR:ophyd.objects:Motion failed: m2_yu is in an alarm state status=AlarmStatus.STATE severity=AlarmSeverity.MAJOR
   ERROR:ophyd.objects:Motion failed: m2_ydi is in an alarm state status=AlarmStatus.STATE severity=AlarmSeverity.MAJOR
   ERROR:ophyd.objects:Motion failed: m2_ydi is in an alarm state status=AlarmStatus.STATE severity=AlarmSeverity.MAJOR
   Out[36]: ()

This is telling you that the amplifiers for two of the M2 jacks
went into an alarm state. In the vast majority of cases, this
simply requires killing and reactivating those amplifiers.

The solution to this one is:

   BMM E.111 [1] ▶ ks.cycle(&#39;m2&#39;)
   Cycling amplifiers on m2 motor controller
   killing amplifiers
   reactivating amplifiers
   enabling motors
</pre></div>
</div>
<section id="old-kill-switch-system">
<h3><span class="section-number">13.6.1. </span>Old kill switch system<a class="headerlink" href="#old-kill-switch-system" title="Permalink to this heading">#</a></h3>
<p>There is a row of switches on rack D, the rack next to the control
station, that are used to disable the amplifiers for the MCS8 motor
controllers.  The cabling for this system still exists, but is not
plugged into the controllers.  Should the DIODE system somehow fail,
this can be redeployed easily.</p>
<figure class="align-center" id="id4">
<span id="fig-killswitches"></span><a class="reference external image-reference" href="_images/Kill_switches.jpg"><img alt="_images/Kill_switches.jpg" src="_images/Kill_switches.jpg" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.2 </span><span class="caption-text">The manual kill switch system</span><a class="headerlink" href="#id4" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>When you suspect that a motor has an amplifier fault, toggle the
appropriate switch to the off position.  Wait 10 seconds (to be very
safe…).  Then toggle the switch back to the on position. The motor
should be ready to go. These switches replace the shorted plugs that
came attached to the “disable” port on the back side of the MCS8s.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>MCS8</p></th>
<th class="head"><p>RGA label</p></th>
<th class="head"><p>RGD label</p></th>
<th class="head"><p>motors</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>MC02</p></td>
<td><p>6BM-100149-RG:A1-PT1B3-A</p></td>
<td><p>6BM-100149-RG:A1-PT1B3-B</p></td>
<td><p>DCM</p></td>
</tr>
<tr class="row-odd"><td><p>MC03</p></td>
<td><p>6BM-100150-RG:A1-PT1B3-A</p></td>
<td><p>6BM-100150-RG:A1-PT1B3-B</p></td>
<td><p>slits2</p></td>
</tr>
<tr class="row-even"><td><p>MC04</p></td>
<td><p>6BM-100151-RG:A1-PT1B3-A</p></td>
<td><p>6BM-100151-RG:A1-PT1B3-B</p></td>
<td><p>M2 + DM2 FS</p></td>
</tr>
<tr class="row-odd"><td><p>MC05</p></td>
<td><p>6BM-100152-RG:A1-PT1B3-A</p></td>
<td><p>6BM-100152-RG:A1-PT1B3-B</p></td>
<td><p>M3 + Filters</p></td>
</tr>
<tr class="row-even"><td><p>MC06</p></td>
<td></td>
<td><p>&lt;installed, not yet labeled&gt;</p></td>
<td><p>DM3 (bct,bpm,fs,foils)+ Slits3</p></td>
</tr>
</tbody>
</table>
</div>
<p>In the situation where toggling the switch does not clear the
amplifier fault, the next troubleshooting step is to power cycle the
MCS8.  This is done by toggling the red, illuminated switch on the
front of the MCS8.  Wait for the red amplifier lights to stop
flickering after turning off the MCS8, then turn the MCS8 back on.</p>
<p>After power cycling the MCS8, it is necessary to re-home all the
motors controlled by the MCS8.</p>
</section>
<section id="mcs8-connector">
<h3><span class="section-number">13.6.2. </span>MCS8 Connector<a class="headerlink" href="#mcs8-connector" title="Permalink to this heading">#</a></h3>
<p>The disable plug on the back of the MCS8 controllers is a Binder RS
connector, part number 468-885. <a class="reference external" href="https://uk.rs-online.com/web/p/industrial-automation-circular-connectors/0468885/?sra=pstk">Here’s an
example.</a></p>
<p>And here is the wiring diagram.  Short the prongs on the side opposite
to the alignment groove.</p>
<figure class="align-center" id="fig-killswitcheconnector">
<a class="reference external image-reference" href="_images/Kill_switch_connector.png"><img alt="_images/Kill_switch_connector.png" src="_images/Kill_switch_connector.png" style="width: 30%;" /></a>
</figure>
<p>Tutorial for how to put together the Binder connectors: <a class="reference download internal" download="" href="_downloads/55576a1ae002c3af9e018e120e040c09/Binder-instructions.pdf"><code class="xref download docutils literal notranslate"><span class="pre">PDF</span></code></a></p>
</section>
</section>
<section id="windows-vm-and-biologic">
<h2><span class="section-number">13.7. </span>Windows VM and BioLogic<a class="headerlink" href="#windows-vm-and-biologic" title="Permalink to this heading">#</a></h2>
<p>We use the <a class="reference external" href="https://www.biologic.net/support-software/ec-lab-software/">BioLogic EC_lab software</a> to run
the <a class="reference external" href="https://www.biologic.net/products/vsp-300/">VSP-300 potentiostat</a>.  Since there is not a
dedicated Windows machine at BMM, EC-Lab is run on a virtual machine
that is spun up when needed.</p>
<p>Similarly, Hiden’s control software is a Window’s only produce.  It is
run on the same firtual machine.</p>
<p>Here are the instructions for starting and interacting with the
the VM.</p>
<section id="starting-the-virtual-machine">
<h3><span class="section-number">13.7.1. </span>Starting the virtual machine<a class="headerlink" href="#starting-the-virtual-machine" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>At a command line, do <code class="docutils literal notranslate"><span class="pre">rdesktop</span> <span class="pre">xf06bm-srv2</span> <span class="pre">&amp;</span></code></p></li>
<li><p>This will open a new window and display a Windows login
screen. Normal BNL credentials do not work. Log in as user
<code class="docutils literal notranslate"><span class="pre">xf06bm</span></code> using the password known by beamline staff.</p></li>
<li><p>The Windows desktop might start with a full-screen management
application that looks like the figure below. You can close
or minimize that window.</p></li>
<li><p>Double-click on the EC-lab or Hiden icon.</p></li>
<li><p>Do some electrochemistry or mass spectrometry.</p></li>
<li><p>Save your electrochemistry or mass spectrometry data to the assets
folder as explained below.</p></li>
</ul>
<figure class="align-center" id="id5">
<span id="fig-winvm"></span><a class="reference external image-reference" href="_images/Winvm_startup.png"><img alt="_images/Winvm_startup.png" src="_images/Winvm_startup.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.3 </span><span class="caption-text">VM management window. You can minimize or close this.</span><a class="headerlink" href="#id5" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="storing-electrochemistry-or-mass-spectrometry-data">
<h3><span class="section-number">13.7.2. </span>Storing electrochemistry or mass spectrometry data<a class="headerlink" href="#storing-electrochemistry-or-mass-spectrometry-data" title="Permalink to this heading">#</a></h3>
<p>The Windows VM has permission to connect to central storage with
permissions to write files from EC-lab or the Hiden software to the
correct location.</p>
<p>To start a new experiment, you first have to disconnect the old drive
(if connected).  This is likely mounted as the <code class="docutils literal notranslate"><span class="pre">Z:</span></code> drive.</p>
<figure class="align-center" id="id6">
<span id="fig-winstaledrive"></span><a class="reference external image-reference" href="_images/Windows_stale_folder.png"><img alt="_images/Windows_stale_folder.png" src="_images/Windows_stale_folder.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.4 </span><span class="caption-text">An example of a stale folder from a previous experiment mounted as
the <code class="docutils literal notranslate"><span class="pre">Z:</span></code> drive.</span><a class="headerlink" href="#id6" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Disconnect the stale <code class="docutils literal notranslate"><span class="pre">Z:</span></code> drive by right clicking on its entry in
the side bar and selecting “Disconnect”.</p>
<figure class="align-center" id="id7">
<span id="fig-windisconnect"></span><a class="reference external image-reference" href="_images/Windows_disconnect.png"><img alt="_images/Windows_disconnect.png" src="_images/Windows_disconnect.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.5 </span><span class="caption-text">Disconnect the stale <code class="docutils literal notranslate"><span class="pre">Z:</span></code> drive.</span><a class="headerlink" href="#id7" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Next, click on “This PC” in the sidebar, then click on the button that
says “Map network drive”.</p>
<figure class="align-center" id="id8">
<span id="fig-winmapnewdrive"></span><a class="reference external image-reference" href="_images/Windows_map_new_drive.png"><img alt="_images/Windows_map_new_drive.png" src="_images/Windows_map_new_drive.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.6 </span><span class="caption-text">Map a new network drive to the VM.</span><a class="headerlink" href="#id8" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>On the “Map Network Drive” page, you need to fill in the path to the
current experiment’s proposal folder.  Suppose the current cycle is
2024-3 and the current proposal number is 316832.  Using <code class="docutils literal notranslate"><span class="pre">Z:</span></code> as the
drive letter, enter the following as the “Folder”</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>\\data3.nsls2.bnl.gov\bmm\proposals\2024-3\pass-316832
</pre></div>
</div>
<p>Note that the backslashes are important.  Also substitute the correct
cycle and proposal numbers.</p>
<p>Be sure to leave “Reconnect at sign-in” checked.  Note that “Connect
using different credentials” should be unchecked.</p>
<figure class="align-center" id="id9">
<span id="fig-winspecifynewdrive"></span><a class="reference external image-reference" href="_images/Windows_specify_new_drive.png"><img alt="_images/Windows_specify_new_drive.png" src="_images/Windows_specify_new_drive.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.7 </span><span class="caption-text">Map a new network drive to the VM.</span><a class="headerlink" href="#id9" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>Click the finish button.  The connection will take several seconds,
but then the new entry will show up in the side bar.</p>
<p>The new network drive can now be clicked into.</p>
<p>Configure EC-lab to write its data files into the
<code class="docutils literal notranslate"><span class="pre">assets\vsp300-1</span></code> folder.</p>
<p>Configure the Hiden software to write its data files into the
<code class="docutils literal notranslate"><span class="pre">assets\hpr20-1</span></code> folder.</p>
<figure class="align-center" id="id10">
<span id="fig-winsassetsfolder"></span><a class="reference external image-reference" href="_images/Windows_assets_folder.png"><img alt="_images/Windows_assets_folder.png" src="_images/Windows_assets_folder.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.8 </span><span class="caption-text">The <code class="docutils literal notranslate"><span class="pre">assets\vsp300-1</span></code> folder is the correct place for data from
EC-lab to be written.  The <code class="docutils literal notranslate"><span class="pre">assets\hpr20-1</span></code> folder is the correct
place for data from the Hiden to be written.</span><a class="headerlink" href="#id10" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>By following this procedure, the electrochemistry data from EC-lab and
mass spectrometry data from the Hiden will be available to the user in
the <a class="reference internal" href="data.html#data"><span class="std std-numref">same manner as their XAS data (Section 4)</span></a>.</p>
</section>
</section>
<section id="calibrate-the-mono">
<h2><span class="section-number">13.8. </span>Calibrate the mono<a class="headerlink" href="#calibrate-the-mono" title="Permalink to this heading">#</a></h2>
<p>The typical calibration procedure involves measuring the angular
position of the Bragg axis for the edge energies of 10 metals: Fe, Co,
Ni, Cu, Zn, Pt, Au, Pb, Nb, and Mo.</p>
<p>The tabulated values of edge energies from Table 1 in <a class="reference external" href="https://doi.org/10.1063/1.1146657">Kraft, et
al.</a> are used in the
calibration.</p>
<ol class="arabic">
<li><p>Be sure that all 10 of these elements are actually mounted on the
reference wheel and configured in the <code class="docutils literal notranslate"><span class="pre">xafs_ref.mapping</span></code> dict.
(They should be.  It would be very unusual for any of these foils
to have been removed from the reference wheel.)</p></li>
<li><p>Run the command</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">calibrate</span><span class="p">(</span><span class="n">mono</span><span class="o">=</span><span class="s1">&#39;111&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">mono='311'</span></code> argument for the Si(311) monochromator.
This will, in sequence, move to each edge and measure a XANES scan
over a wide enough range that it should cover the edge (unless the
mono is currently calibrated VERY wrongly).  This will write a file
called <code class="file docutils literal notranslate"><span class="pre">edges111.ini</span></code> (or <code class="file docutils literal notranslate"><span class="pre">edges3111.ini</span></code>).  Each XANES
scan uses the file
<code class="file docutils literal notranslate"><span class="pre">/home/xf06bm/Data/Staff/mono_calibration/cal.ini</span></code> as the INI
file.  Edge appropriate command line parameters will be added by
the <code class="docutils literal notranslate"><span class="pre">calibrate()</span></code> plan.</p>
</li>
<li><p>Examine the data in <span class="smallcaps">athena</span>. Make sure E<sub>0</sub> is selected
correctly for all 10 edges. Copy those values into the first column
of <code class="file docutils literal notranslate"><span class="pre">edges111.ini</span></code> (or <code class="file docutils literal notranslate"><span class="pre">edges311.ini</span></code>).</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>It is no longer necessary to compute the angular positions of
the monochromator.  Those will be computed from the edge energy
values you edited into the INI file by hand.</p>
</div>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<p>Implement on-the-fly determination of E<sub>0</sub> to obviate the
step of editing the INI file.  Pb is tricky.  Nb and Mo are kind
of tricky.</p>
</div>
</li>
<li><p>Run the command</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">calibrate_mono</span><span class="p">(</span><span class="n">mono</span><span class="o">=</span><span class="s1">&#39;111&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>(or use the <code class="docutils literal notranslate"><span class="pre">'311'</span></code> argument).  This will show the fitting
results and plot the best fit.  It will also print in a text box
instructions for modifying the <code class="file docutils literal notranslate"><span class="pre">BMM/dcm-parameters.py</span></code> file
to use the new calibration values.</p>
<figure class="align-center" id="id11">
<span id="fig-calibrate"></span><a class="reference external image-reference" href="_images/Calibration_111.png"><img alt="_images/Calibration_111.png" src="_images/Calibration_111.png" style="width: 70%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13.9 </span><span class="caption-text">Example calibration curve</span><a class="headerlink" href="#id11" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</li>
<li><p>Edit <code class="file docutils literal notranslate"><span class="pre">BMM/dcm-parameters.py</span></code> as indicated.</p></li>
<li><p>Do</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">run</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;home/xf06bm/.ipython/profile_collection/startup/BMM/dcm-parameters.py&#39;</span>
</pre></div>
</div>
<p>then do</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dcm</span><span class="o">.</span><span class="n">set_crystal</span><span class="p">()</span>
</pre></div>
</div>
<p>Or simply restart <span class="bolditalic">bsui</span>, which is usually the easier thing.</p>
</li>
<li><p>Finally, do</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">calibrate_pitch</span><span class="p">(</span><span class="n">mono</span><span class="o">=</span><span class="s1">&#39;111&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This performs a simple linear fit to the rocking curve peak
positions for <code class="docutils literal notranslate"><span class="pre">dcm_pitch</span></code> found at each edge.  Use the fitted
slope and offset to modify <code class="docutils literal notranslate"><span class="pre">approximate_pitch</span></code> in
<code class="file docutils literal notranslate"><span class="pre">BMM/functions.py</span></code>.</p>
</li>
</ol>
<p>The mono should now be correctly calibrated using the new calibration
parameters.</p>
</section>
<section id="provision-a-new-beamline-computer">
<h2><span class="section-number">13.9. </span>Provision a new beamline computer<a class="headerlink" href="#provision-a-new-beamline-computer" title="Permalink to this heading">#</a></h2>
<p>This is a list of notes on how to finish the provisioning of a new
beamline computer.</p>
<p>Firstly, make sure that <code class="docutils literal notranslate"><span class="pre">/nsls2/data</span></code> is a symlink to
<code class="docutils literal notranslate"><span class="pre">/nsls2/data3</span></code>.  If it is not, ask for help from DSSI.</p>
<section id="install-additional-packages">
<h3><span class="section-number">13.9.1. </span>install additional packages<a class="headerlink" href="#install-additional-packages" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>plasma-desktop (just … better)</p></li>
<li><p>redis (essential for operation of <span class="bolditalic">bsui</span>)</p></li>
<li><p>most (used as the pager in BMM’s <span class="bolditalic">bsui</span> profile)</p></li>
<li><p>ag (powerful ack-like grep alternative)</p></li>
<li><p>fswebcam (used to capture analog pinhole camera)</p></li>
<li><p>demeter and perl-Graphics-GnuplotIF (something silly, no doubt)</p></li>
<li><p>slack (communications)</p></li>
<li><p>ark (compression, useful in file manager)</p></li>
</ul>
<p>To install these, do:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>dzdo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>redis<span class="w"> </span>most<span class="w"> </span>ag<span class="w"> </span>fswebcam<span class="w"> </span>demeter<span class="w"> </span>perl-Graphics-GnuplotIF<span class="w"> </span>slack<span class="w"> </span>ark
dzdo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>--skip-broken<span class="w"> </span>--nobest<span class="w"> </span>@kde-desktop
</pre></div>
</div>
<p>The second command installs the KDE metapackage, skipping missing
packages.</p>
<p>To finish installing <code class="docutils literal notranslate"><span class="pre">sddm</span></code>, do</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>dzdo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>gdm
dzdo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>sddm
</pre></div>
</div>
</section>
<section id="desktop-wallpaper">
<h3><span class="section-number">13.9.2. </span>Desktop wallpaper<a class="headerlink" href="#desktop-wallpaper" title="Permalink to this heading">#</a></h3>
<p>This may not be provisioned correctly out of the box.  Find the
beamline wallpapers in <code class="docutils literal notranslate"><span class="pre">/usr/share/nsls2/wallpapers/beamlines</span></code>.</p>
<p>Right click on the desktop and select “Configure Desktop and
Wallpaper”.  Click on “Add Image” and navigate to the folder above.</p>
</section>
<section id="things-to-install-from-git">
<h3><span class="section-number">13.9.3. </span>Things to install from git<a class="headerlink" href="#things-to-install-from-git" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>BMM stuff: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:NSLS-II-BMM/BMM-beamline-configuration.git</span></code>
+ then, <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/bin</span></code> and <code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">~/git/BMM-beamline-configuration/tools/run-cadashboard</span></code></p></li>
<li><p>BMM user manual: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:NSLS2/bmm-beamline-manual.git</span></code></p></li>
<li><p>BMM standards: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:NSLS2/bmm-standards.git</span></code></p></li>
<li><p>Switch visualization: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:NSLS-II-BMM/switch-pretty-printer.git</span></code></p></li>
</ul>
<p>Also do <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/bin</span></code> and <code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">~/.ipython/profile_collection/startup/consumer/run-consumer</span></code></p>
</section>
<section id="workspace-folders">
<h3><span class="section-number">13.9.4. </span>Workspace folders<a class="headerlink" href="#workspace-folders" title="Permalink to this heading">#</a></h3>
<p>Make the local data collection folders.  The
<a class="reference internal" href="#start-end"><span class="std std-numref">BMMuser.begin_experiment() command (Section 13.1)</span></a>
will make symlinks under those folders to the correct place on central
storage.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mkdir ~/Workspace
mkdir ~/Workspace/Visitors
mkdir ~/Workspace/Staff
</pre></div>
</div>
</section>
</section>
<section id="manage-silicon-drift-detectors">
<h2><span class="section-number">13.10. </span>Manage Silicon Drift Detectors<a class="headerlink" href="#manage-silicon-drift-detectors" title="Permalink to this heading">#</a></h2>
<p>The assumption in the data acquisition system is that one of the three
silicon drift detectors will be the primary detector in an experiment.
At the <span class="bolditalic">bsui</span> command line (or in <span class="bolditalic">queueserver</span>) the <code class="docutils literal notranslate"><span class="pre">xs</span></code> symbol should
point at the correct detector.  Also, a parameter is set in Redis
allowing other processes (such as the Kafka plotting agent) to know
which detector to be paying attention to.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xs</span> <span class="o">=</span> <span class="n">xspress3_set_detector</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</pre></div>
</div>
<p>where the argument to <code class="docutils literal notranslate"><span class="pre">xspress3_set_detector</span></code> is 1, 4, or 7.  Since
October 2024, use of the seven element detector is the default.</p>
<p>This sets <code class="docutils literal notranslate"><span class="pre">xs</span></code> to the selected detector object – <code class="docutils literal notranslate"><span class="pre">xs1</span></code>,
<code class="docutils literal notranslate"><span class="pre">xs4</span></code>, or <code class="docutils literal notranslate"><span class="pre">xs7</span></code>.</p>
<p>Also set is the Redis parameter <code class="docutils literal notranslate"><span class="pre">BMM:xspress3</span></code>, which is set to 1,
4, or 7 (and represented as a b-string).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rkvs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BMM:xspress3&#39;</span><span class="p">))</span>
</pre></div>
</div>

<br>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="log.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">12. </span>Experimental Log</p>
      </div>
    </a>
    <a class="right-next"
       href="commonchores.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">14. </span>Common chores</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-and-ending-an-experiment">13.1. Starting and ending an experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#change-energy">13.2. Change energy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#change-crystals">13.3. Change crystals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#change-xas-larr-xrd">13.4. Change XAS → XRD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#xafs-with-si-333">13.5. XAFS with Si(333)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motor-controller-kill-switches">13.6. Motor controller kill switches</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#old-kill-switch-system">13.6.1. Old kill switch system</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mcs8-connector">13.6.2. MCS8 Connector</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#windows-vm-and-biologic">13.7. Windows VM and BioLogic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-the-virtual-machine">13.7.1. Starting the virtual machine</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-electrochemistry-or-mass-spectrometry-data">13.7.2. Storing electrochemistry or mass spectrometry data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calibrate-the-mono">13.8. Calibrate the mono</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#provision-a-new-beamline-computer">13.9. Provision a new beamline computer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#install-additional-packages">13.9.1. install additional packages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#desktop-wallpaper">13.9.2. Desktop wallpaper</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#things-to-install-from-git">13.9.3. Things to install from git</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#workspace-folders">13.9.4. Workspace folders</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#manage-silicon-drift-detectors">13.10. Manage Silicon Drift Detectors</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Bruce Ravel
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>